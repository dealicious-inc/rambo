(()=>{document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("room-list"),t=new URLSearchParams(window.location.search);if(!e){console.warn("room-list \uC694\uC18C\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.");return}let s=parseInt(t.get("userId"));if(!s){alert("\u2757 URL\uC5D0 userId \uCFFC\uB9AC \uD30C\uB77C\uBBF8\uD130\uAC00 \uD544\uC694\uD569\uB2C8\uB2E4. \uC608: /live_chat?userId=1");return}let a={1:"\uAE40\uC870\uC21C",2:"\uC774\uC870\uC21C",3:"\uB098\uC870\uC21C",4:"\uBC15\uC870\uC21C"}[s]||`\uC0AC\uC6A9\uC790${s}`;fetch("/api/rooms").then(o=>{if(!o.ok)throw new Error("\uBC29 \uBAA9\uB85D \uAC00\uC838\uC624\uAE30 \uC2E4\uD328");return o.json()}).then(o=>{o.forEach(r=>{let i=document.createElement("li");i.textContent=r.name,i.style.cursor="pointer",i.style.color="blue",i.style.textDecoration="underline",i.addEventListener("click",()=>{window.location.href=`/live_chat?room_id=${r.id}&room_name=${encodeURIComponent(r.name)}&userId=${s}&userName=${encodeURIComponent(a)}`}),e.appendChild(i)})}).catch(o=>{console.error("\uBC29 \uBAA9\uB85D \uB85C\uB4DC \uC5D0\uB7EC:",o);let r=document.createElement("li");r.textContent="\uBC29 \uBAA9\uB85D\uC744 \uBD88\uB7EC\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.",e.appendChild(r)})});var x=e=>typeof e=="function"?e:function(){return e},N=typeof self!="undefined"?self:null,I=typeof window!="undefined"?window:null,j=N||I||j,D="2.0.0",k={connecting:0,open:1,closing:2,closed:3},O=1e4,J=1e3,E={closed:"closed",errored:"errored",joined:"joined",joining:"joining",leaving:"leaving"},S={close:"phx_close",error:"phx_error",join:"phx_join",reply:"phx_reply",leave:"phx_leave"},P={longpoll:"longpoll",websocket:"websocket"},z={complete:4},M=class{constructor(e,t,s,n){this.channel=e,this.event=t,this.payload=s||function(){return{}},this.receivedResp=null,this.timeout=n,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}resend(e){this.timeout=e,this.reset(),this.send()}send(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}receive(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}reset(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}matchReceive({status:e,response:t,_ref:s}){this.recHooks.filter(n=>n.status===e).forEach(n=>n.callback(t))}cancelRefEvent(){this.refEvent&&this.channel.off(this.refEvent)}cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}startTimeout(){this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,e=>{this.cancelRefEvent(),this.cancelTimeout(),this.receivedResp=e,this.matchReceive(e)}),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}trigger(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}},U=class{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=null,this.tries=0}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}},F=class{constructor(e,t,s){this.state=E.closed,this.topic=e,this.params=x(t||{}),this.socket=s,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new M(this,S.join,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new U(()=>{this.socket.isConnected()&&this.rejoin()},this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError(()=>this.rejoinTimer.reset())),this.stateChangeRefs.push(this.socket.onOpen(()=>{this.rejoinTimer.reset(),this.isErrored()&&this.rejoin()})),this.joinPush.receive("ok",()=>{this.state=E.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(n=>n.send()),this.pushBuffer=[]}),this.joinPush.receive("error",()=>{this.state=E.errored,this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.onClose(()=>{this.rejoinTimer.reset(),this.socket.hasLogger()&&this.socket.log("channel",`close ${this.topic} ${this.joinRef()}`),this.state=E.closed,this.socket.remove(this)}),this.onError(n=>{this.socket.hasLogger()&&this.socket.log("channel",`error ${this.topic}`,n),this.isJoining()&&this.joinPush.reset(),this.state=E.errored,this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.joinPush.receive("timeout",()=>{this.socket.hasLogger()&&this.socket.log("channel",`timeout ${this.topic} (${this.joinRef()})`,this.joinPush.timeout),new M(this,S.leave,x({}),this.timeout).send(),this.state=E.errored,this.joinPush.reset(),this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.on(S.reply,(n,a)=>{this.trigger(this.replyEventName(a),n)})}join(e=this.timeout){if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}onClose(e){this.on(S.close,e)}onError(e){return this.on(S.error,t=>e(t))}on(e,t){let s=this.bindingRef++;return this.bindings.push({event:e,ref:s,callback:t}),s}off(e,t){this.bindings=this.bindings.filter(s=>!(s.event===e&&(typeof t=="undefined"||t===s.ref)))}canPush(){return this.socket.isConnected()&&this.isJoined()}push(e,t,s=this.timeout){if(t=t||{},!this.joinedOnce)throw new Error(`tried to push '${e}' to '${this.topic}' before joining. Use channel.join() before pushing events`);let n=new M(this,e,function(){return t},s);return this.canPush()?n.send():(n.startTimeout(),this.pushBuffer.push(n)),n}leave(e=this.timeout){this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=E.leaving;let t=()=>{this.socket.hasLogger()&&this.socket.log("channel",`leave ${this.topic}`),this.trigger(S.close,"leave")},s=new M(this,S.leave,x({}),e);return s.receive("ok",()=>t()).receive("timeout",()=>t()),s.send(),this.canPush()||s.trigger("ok",{}),s}onMessage(e,t,s){return t}isMember(e,t,s,n){return this.topic!==e?!1:n&&n!==this.joinRef()?(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:s,joinRef:n}),!1):!0}joinRef(){return this.joinPush.ref}rejoin(e=this.timeout){this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=E.joining,this.joinPush.resend(e))}trigger(e,t,s,n){let a=this.onMessage(e,t,s,n);if(t&&!a)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");let o=this.bindings.filter(r=>r.event===e);for(let r=0;r<o.length;r++)o[r].callback(a,s,n||this.joinRef())}replyEventName(e){return`chan_reply_${e}`}isClosed(){return this.state===E.closed}isErrored(){return this.state===E.errored}isJoined(){return this.state===E.joined}isJoining(){return this.state===E.joining}isLeaving(){return this.state===E.leaving}},H=class{static request(e,t,s,n,a,o,r){if(j.XDomainRequest){let i=new j.XDomainRequest;return this.xdomainRequest(i,e,t,n,a,o,r)}else{let i=new j.XMLHttpRequest;return this.xhrRequest(i,e,t,s,n,a,o,r)}}static xdomainRequest(e,t,s,n,a,o,r){return e.timeout=a,e.open(t,s),e.onload=()=>{let i=this.parseJSON(e.responseText);r&&r(i)},o&&(e.ontimeout=o),e.onprogress=()=>{},e.send(n),e}static xhrRequest(e,t,s,n,a,o,r,i){return e.open(t,s,!0),e.timeout=o,e.setRequestHeader("Content-Type",n),e.onerror=()=>i&&i(null),e.onreadystatechange=()=>{if(e.readyState===z.complete&&i){let c=this.parseJSON(e.responseText);i(c)}},r&&(e.ontimeout=r),e.send(a),e}static parseJSON(e){if(!e||e==="")return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}static serialize(e,t){let s=[];for(var n in e){if(!Object.prototype.hasOwnProperty.call(e,n))continue;let a=t?`${t}[${n}]`:n,o=e[n];typeof o=="object"?s.push(this.serialize(o,a)):s.push(encodeURIComponent(a)+"="+encodeURIComponent(o))}return s.join("&")}static appendParams(e,t){if(Object.keys(t).length===0)return e;let s=e.match(/\?/)?"&":"?";return`${e}${s}${this.serialize(t)}`}},W=e=>{let t="",s=new Uint8Array(e),n=s.byteLength;for(let a=0;a<n;a++)t+=String.fromCharCode(s[a]);return btoa(t)},$=class{constructor(e){this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.awaitingBatchAck=!1,this.currentBatch=null,this.currentBatchTimer=null,this.batchBuffer=[],this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(e),this.readyState=k.connecting,setTimeout(()=>this.poll(),0)}normalizeEndpoint(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+P.websocket),"$1/"+P.longpoll)}endpointURL(){return H.appendParams(this.pollEndpoint,{token:this.token})}closeAndRetry(e,t,s){this.close(e,t,s),this.readyState=k.connecting}ontimeout(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}isActive(){return this.readyState===k.open||this.readyState===k.connecting}poll(){this.ajax("GET","application/json",null,()=>this.ontimeout(),e=>{if(e){var{status:t,token:s,messages:n}=e;this.token=s}else t=0;switch(t){case 200:n.forEach(a=>{setTimeout(()=>this.onmessage({data:a}),0)}),this.poll();break;case 204:this.poll();break;case 410:this.readyState=k.open,this.onopen({}),this.poll();break;case 403:this.onerror(403),this.close(1008,"forbidden",!1);break;case 0:case 500:this.onerror(500),this.closeAndRetry(1011,"internal server error",500);break;default:throw new Error(`unhandled poll status ${t}`)}})}send(e){typeof e!="string"&&(e=W(e)),this.currentBatch?this.currentBatch.push(e):this.awaitingBatchAck?this.batchBuffer.push(e):(this.currentBatch=[e],this.currentBatchTimer=setTimeout(()=>{this.batchSend(this.currentBatch),this.currentBatch=null},0))}batchSend(e){this.awaitingBatchAck=!0,this.ajax("POST","application/x-ndjson",e.join(`
`),()=>this.onerror("timeout"),t=>{this.awaitingBatchAck=!1,!t||t.status!==200?(this.onerror(t&&t.status),this.closeAndRetry(1011,"internal server error",!1)):this.batchBuffer.length>0&&(this.batchSend(this.batchBuffer),this.batchBuffer=[])})}close(e,t,s){for(let a of this.reqs)a.abort();this.readyState=k.closed;let n=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:s});this.batchBuffer=[],clearTimeout(this.currentBatchTimer),this.currentBatchTimer=null,typeof CloseEvent!="undefined"?this.onclose(new CloseEvent("close",n)):this.onclose(n)}ajax(e,t,s,n,a){let o,r=()=>{this.reqs.delete(o),n()};o=H.request(e,this.endpointURL(),t,s,this.timeout,r,i=>{this.reqs.delete(o),this.isActive()&&a(i)}),this.reqs.add(o)}};var A={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));{let s=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(s))}},decode(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));{let[s,n,a,o,r]=JSON.parse(e);return t({join_ref:s,ref:n,topic:a,event:o,payload:r})}},binaryEncode(e){let{join_ref:t,ref:s,event:n,topic:a,payload:o}=e,r=this.META_LENGTH+t.length+s.length+a.length+n.length,i=new ArrayBuffer(this.HEADER_LENGTH+r),c=new DataView(i),d=0;c.setUint8(d++,this.KINDS.push),c.setUint8(d++,t.length),c.setUint8(d++,s.length),c.setUint8(d++,a.length),c.setUint8(d++,n.length),Array.from(t,m=>c.setUint8(d++,m.charCodeAt(0))),Array.from(s,m=>c.setUint8(d++,m.charCodeAt(0))),Array.from(a,m=>c.setUint8(d++,m.charCodeAt(0))),Array.from(n,m=>c.setUint8(d++,m.charCodeAt(0)));var v=new Uint8Array(i.byteLength+o.byteLength);return v.set(new Uint8Array(i),0),v.set(new Uint8Array(o),i.byteLength),v.buffer},binaryDecode(e){let t=new DataView(e),s=t.getUint8(0),n=new TextDecoder;switch(s){case this.KINDS.push:return this.decodePush(e,t,n);case this.KINDS.reply:return this.decodeReply(e,t,n);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,n)}},decodePush(e,t,s){let n=t.getUint8(1),a=t.getUint8(2),o=t.getUint8(3),r=this.HEADER_LENGTH+this.META_LENGTH-1,i=s.decode(e.slice(r,r+n));r=r+n;let c=s.decode(e.slice(r,r+a));r=r+a;let d=s.decode(e.slice(r,r+o));r=r+o;let v=e.slice(r,e.byteLength);return{join_ref:i,ref:null,topic:c,event:d,payload:v}},decodeReply(e,t,s){let n=t.getUint8(1),a=t.getUint8(2),o=t.getUint8(3),r=t.getUint8(4),i=this.HEADER_LENGTH+this.META_LENGTH,c=s.decode(e.slice(i,i+n));i=i+n;let d=s.decode(e.slice(i,i+a));i=i+a;let v=s.decode(e.slice(i,i+o));i=i+o;let m=s.decode(e.slice(i,i+r));i=i+r;let u=e.slice(i,e.byteLength),C={status:m,response:u};return{join_ref:c,ref:d,topic:v,event:S.reply,payload:C}},decodeBroadcast(e,t,s){let n=t.getUint8(1),a=t.getUint8(2),o=this.HEADER_LENGTH+2,r=s.decode(e.slice(o,o+n));o=o+n;let i=s.decode(e.slice(o,o+a));o=o+a;let c=e.slice(o,e.byteLength);return{join_ref:null,ref:null,topic:r,event:i,payload:c}}},w=class{constructor(e,t={}){this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=t.timeout||O,this.transport=t.transport||j.WebSocket||$,this.primaryPassedHealthCheck=!1,this.longPollFallbackMs=t.longPollFallbackMs,this.fallbackTimer=null,this.sessionStore=t.sessionStorage||j&&j.sessionStorage,this.establishedConnections=0,this.defaultEncoder=A.encode.bind(A),this.defaultDecoder=A.decode.bind(A),this.closeWasClean=!1,this.disconnecting=!1,this.binaryType=t.binaryType||"arraybuffer",this.connectClock=1,this.transport!==$?(this.encode=t.encode||this.defaultEncoder,this.decode=t.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);let s=null;I&&I.addEventListener&&(I.addEventListener("pagehide",n=>{this.conn&&(this.disconnect(),s=this.connectClock)}),I.addEventListener("pageshow",n=>{s===this.connectClock&&(s=null,this.connect())})),this.heartbeatIntervalMs=t.heartbeatIntervalMs||3e4,this.rejoinAfterMs=n=>t.rejoinAfterMs?t.rejoinAfterMs(n):[1e3,2e3,5e3][n-1]||1e4,this.reconnectAfterMs=n=>t.reconnectAfterMs?t.reconnectAfterMs(n):[10,50,100,150,200,250,500,1e3,2e3][n-1]||5e3,this.logger=t.logger||null,!this.logger&&t.debug&&(this.logger=(n,a,o)=>{console.log(`${n}: ${a}`,o)}),this.longpollerTimeout=t.longpollerTimeout||2e4,this.params=x(t.params||{}),this.endPoint=`${e}/${P.websocket}`,this.vsn=t.vsn||D,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new U(()=>{this.teardown(()=>this.connect())},this.reconnectAfterMs)}getLongPollTransport(){return $}replaceTransport(e){this.connectClock++,this.closeWasClean=!0,clearTimeout(this.fallbackTimer),this.reconnectTimer.reset(),this.conn&&(this.conn.close(),this.conn=null),this.transport=e}protocol(){return location.protocol.match(/^https/)?"wss":"ws"}endPointURL(){let e=H.appendParams(H.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return e.charAt(0)!=="/"?e:e.charAt(1)==="/"?`${this.protocol()}:${e}`:`${this.protocol()}://${location.host}${e}`}disconnect(e,t,s){this.connectClock++,this.disconnecting=!0,this.closeWasClean=!0,clearTimeout(this.fallbackTimer),this.reconnectTimer.reset(),this.teardown(()=>{this.disconnecting=!1,e&&e()},t,s)}connect(e){e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=x(e)),!(this.conn&&!this.disconnecting)&&(this.longPollFallbackMs&&this.transport!==$?this.connectWithFallback($,this.longPollFallbackMs):this.transportConnect())}log(e,t,s){this.logger&&this.logger(e,t,s)}hasLogger(){return this.logger!==null}onOpen(e){let t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}onClose(e){let t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}onError(e){let t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}onMessage(e){let t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}ping(e){if(!this.isConnected())return!1;let t=this.makeRef(),s=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:t});let n=this.onMessage(a=>{a.ref===t&&(this.off([n]),e(Date.now()-s))});return!0}transportConnect(){this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=()=>this.onConnOpen(),this.conn.onerror=e=>this.onConnError(e),this.conn.onmessage=e=>this.onConnMessage(e),this.conn.onclose=e=>this.onConnClose(e)}getSession(e){return this.sessionStore&&this.sessionStore.getItem(e)}storeSession(e,t){this.sessionStore&&this.sessionStore.setItem(e,t)}connectWithFallback(e,t=2500){clearTimeout(this.fallbackTimer);let s=!1,n=!0,a,o,r=i=>{this.log("transport",`falling back to ${e.name}...`,i),this.off([a,o]),n=!1,this.replaceTransport(e),this.transportConnect()};if(this.getSession(`phx:fallback:${e.name}`))return r("memorized");this.fallbackTimer=setTimeout(r,t),o=this.onError(i=>{this.log("transport","error",i),n&&!s&&(clearTimeout(this.fallbackTimer),r(i))}),this.onOpen(()=>{if(s=!0,!n)return this.primaryPassedHealthCheck||this.storeSession(`phx:fallback:${e.name}`,"true"),this.log("transport",`established ${e.name} fallback`);clearTimeout(this.fallbackTimer),this.fallbackTimer=setTimeout(r,t),this.ping(i=>{this.log("transport","connected to primary after",i),this.primaryPassedHealthCheck=!0,clearTimeout(this.fallbackTimer)})}),this.transportConnect()}clearHeartbeats(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}onConnOpen(){this.hasLogger()&&this.log("transport",`${this.transport.name} connected to ${this.endPointURL()}`),this.closeWasClean=!1,this.disconnecting=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach(([,e])=>e())}heartbeatTimeout(){this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown(()=>this.reconnectTimer.scheduleTimeout(),J,"heartbeat timeout"))}resetHeartbeat(){this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout(()=>this.sendHeartbeat(),this.heartbeatIntervalMs))}teardown(e,t,s){if(!this.conn)return e&&e();let n=this.connectClock;this.waitForBufferDone(()=>{n===this.connectClock&&(this.conn&&(t?this.conn.close(t,s||""):this.conn.close()),this.waitForSocketClosed(()=>{n===this.connectClock&&(this.conn&&(this.conn.onopen=function(){},this.conn.onerror=function(){},this.conn.onmessage=function(){},this.conn.onclose=function(){},this.conn=null),e&&e())}))})}waitForBufferDone(e,t=1){if(t===5||!this.conn||!this.conn.bufferedAmount){e();return}setTimeout(()=>{this.waitForBufferDone(e,t+1)},150*t)}waitForSocketClosed(e,t=1){if(t===5||!this.conn||this.conn.readyState===k.closed){e();return}setTimeout(()=>{this.waitForSocketClosed(e,t+1)},150*t)}onConnClose(e){let t=e&&e.code;this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),!this.closeWasClean&&t!==1e3&&this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(([,s])=>s(e))}onConnError(e){this.hasLogger()&&this.log("transport",e);let t=this.transport,s=this.establishedConnections;this.stateChangeCallbacks.error.forEach(([,n])=>{n(e,t,s)}),(t===this.transport||s>0)&&this.triggerChanError()}triggerChanError(){this.channels.forEach(e=>{e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(S.error)})}connectionState(){switch(this.conn&&this.conn.readyState){case k.connecting:return"connecting";case k.open:return"open";case k.closing:return"closing";default:return"closed"}}isConnected(){return this.connectionState()==="open"}remove(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter(t=>t!==e)}off(e){for(let t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter(([s])=>e.indexOf(s)===-1)}channel(e,t={}){let s=new F(e,t,this);return this.channels.push(s),s}push(e){if(this.hasLogger()){let{topic:t,event:s,payload:n,ref:a,join_ref:o}=e;this.log("push",`${t} ${s} (${o}, ${a})`,n)}this.isConnected()?this.encode(e,t=>this.conn.send(t)):this.sendBuffer.push(()=>this.encode(e,t=>this.conn.send(t)))}makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}sendHeartbeat(){this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout(()=>this.heartbeatTimeout(),this.heartbeatIntervalMs))}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}onConnMessage(e){this.decode(e.data,t=>{let{topic:s,event:n,payload:a,ref:o,join_ref:r}=t;o&&o===this.pendingHeartbeatRef&&(this.clearHeartbeats(),this.pendingHeartbeatRef=null,this.heartbeatTimer=setTimeout(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)),this.hasLogger()&&this.log("receive",`${a.status||""} ${s} ${n} ${o&&"("+o+")"||""}`,a);for(let i=0;i<this.channels.length;i++){let c=this.channels[i];c.isMember(s,n,a,r)&&c.trigger(n,a,o,r)}for(let i=0;i<this.stateChangeCallbacks.message.length;i++){let[,c]=this.stateChangeCallbacks.message[i];c(t)}})}leaveOpenTopic(e){let t=this.channels.find(s=>s.topic===e&&(s.isJoined()||s.isJoining()));t&&(this.hasLogger()&&this.log("transport",`leaving duplicate topic "${e}"`),t.leave())}};document.addEventListener("DOMContentLoaded",()=>{if(!document.querySelector("#live-chat"))return;let t=new URLSearchParams(window.location.search),s=t.get("room_id"),n=t.get("userId"),a=t.get("userName"),o=t.get("room_name");if(!s||!n){console.warn("\u274C room_id \uB610\uB294 userId \uB204\uB77D\uB428");return}let r=document.getElementById("back-button");r&&r.addEventListener("click",()=>{window.location.href=`/rooms?userId=${n}`});let i=document.getElementById("messages"),c=document.getElementById("message-input"),d=document.getElementById("send-button");if(!i||!c||!d){console.warn("\u274C \uD544\uC218 UI \uC694\uC18C \uB204\uB77D");return}let v=new w("/socket",{params:{userToken:"123"}});v.connect();let m=v.channel(`room:${s}`,{user_id:n,user_name:a});m.join().receive("ok",()=>console.log("\u2705 \uCC44\uB110 \uC870\uC778 \uC644\uB8CC")).receive("error",h=>console.error("\u274C \uCC44\uB110 \uC870\uC778 \uC2E4\uD328",h)),m.on("new_msg",h=>{let l=document.createElement("li"),g=h.type||"chat",y=new Date(h.timestamp),b=`${y.getHours().toString().padStart(2,"0")}:${y.getMinutes().toString().padStart(2,"0")}`;if(g==="notice")l.textContent=`\u{1F4E2} ${h.message}`,l.style.textAlign="center",l.style.fontWeight="bold",l.style.color="#c0392b";else if(g==="system")l.textContent=h.message,l.style.textAlign="center",l.style.fontStyle="italic",l.style.color="gray";else{let T=document.createElement("span");T.textContent=`${h.user_name}: ${h.message}`;let _=document.createElement("span");_.textContent=` ${b}`,_.style.fontSize="0.8em",_.style.color="gray",_.style.marginLeft="8px",l.appendChild(T),l.appendChild(_)}i.appendChild(l)}),m.on("user_count",h=>{let l=document.getElementById("user-count");l&&(l.innerText=`\u{1F465} ${h.count}\uBA85 \uCC38\uC5EC \uC911`)}),m.on("ban_chat",h=>{let l=document.createElement("li");l.textContent=h.reason||"\uCC44\uD305 \uC81C\uD55C \uC911\uC785\uB2C8\uB2E4.",l.style.color="red",i.appendChild(l)});let u=document.getElementById("room-name");o&&u&&(u.innerText=decodeURIComponent(o));function C(){let h=c.value.trim();h!==""&&(m.push("send_live_msg",{id:s,user_id:n,user_name:a,message:h}),c.value="")}d.addEventListener("click",C);let f=!1;c.addEventListener("compositionstart",()=>f=!0),c.addEventListener("compositionend",()=>f=!1),c.addEventListener("keydown",h=>{h.key==="Enter"&&!f&&(h.preventDefault(),C())});let R=document.getElementById("report-button"),L=document.getElementById("report-modal"),B=document.getElementById("close-report-modal"),p=document.getElementById("report-user-list");R&&L&&B&&p&&(R.addEventListener("click",()=>{fetch(`/api/rooms/${s}/participate-users`).then(h=>h.json()).then(h=>{p.innerHTML="",h.users.forEach(l=>{if(String(l.user_id)===String(n))return;let g=document.createElement("li");g.style.marginBottom="8px";let y=document.createElement("span");y.textContent=l.user_name,y.style.marginRight="8px";let b=document.createElement("button");b.textContent="\uC2E0\uACE0",Object.assign(b.style,{padding:"2px 8px",backgroundColor:"#e74c3c",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"}),b.addEventListener("click",()=>{fetch("/api/rooms/ban-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:l.user_id})}).then(T=>T.json()).then(()=>{alert("\u2705 \uC2E0\uACE0 \uC644\uB8CC: 5\uBD84\uAC04 \uCC44\uD305\uC774 \uC81C\uD55C\uB429\uB2C8\uB2E4."),L.style.display="none"}).catch(T=>{alert("\u274C \uC2E0\uACE0 \uC2E4\uD328"),console.error(T)})}),g.appendChild(y),g.appendChild(b),p.appendChild(g)}),L.style.display="block"}).catch(h=>{alert("\u274C \uC0AC\uC6A9\uC790 \uBAA9\uB85D \uBD88\uB7EC\uC624\uAE30 \uC2E4\uD328"),console.error(h)})}),B.addEventListener("click",()=>{L.style.display="none"}))});document.addEventListener("DOMContentLoaded",()=>{if(!document.querySelector("#chat-root"))return;console.log("\u2705 chat.js \uC2E4\uD589\uB428");let t=new URLSearchParams(window.location.search),s=t.get("room_id"),n=t.get("userId");if(!s){console.log("room_id \uC5C6\uC74C \u2192 chat.js \uC2E4\uD589 \uC548\uD568");return}if(!n){console.error("userId \uB204\uB77D\uB428, \uCC44\uB110 join \uBD88\uAC00");return}let a=document.getElementById("back-button");a&&n&&a.addEventListener("click",()=>{window.location.href=`/rooms?userId=${n}`});let o=document.getElementById("messages"),r=document.getElementById("message-input"),i=document.getElementById("send-button");if(!o||!r||!i){console.log("\uD544\uC694\uD55C \uCC44\uD305 UI \uC694\uC18C\uAC00 \uC5C6\uC74C \u2192 \uC2E4\uD589 \uC548\uD568");return}let c=new w("/socket",{params:{userToken:"123"}});c.connect();let d=c.channel(`room:${s}`,{user_id:n});d.join().receive("ok",f=>{console.log("Joining channel with:",{user_id:n})}).receive("error",f=>{console.error("\u274C Unable to join",f)}),d.on("new_msg",f=>{let R=document.createElement("li");R.textContent=`${f.user}: ${f.content} (${f.timestamp})`,o.appendChild(R)});let v=t.get("room_name"),m=document.getElementById("room-name");v&&m&&(m.innerText=decodeURIComponent(v),m.style.fontSize="20px");function u(){let f=r.value;f.trim()!==""&&(d.push("new_msg",{id:s,user:n,message:f}),r.value="")}i.addEventListener("click",u);let C=!1;r.addEventListener("compositionstart",()=>{C=!0}),r.addEventListener("compositionend",()=>{C=!1,u()}),r.addEventListener("keydown",f=>{f.key==="Enter"&&!C&&(f.preventDefault(),u())})});document.addEventListener("DOMContentLoaded",()=>{let e=new URLSearchParams(window.location.search),t=parseInt(e.get("userId"));if(!t){alert("\u2757 URL\uC5D0 userId \uCFFC\uB9AC \uD30C\uB77C\uBBF8\uD130\uAC00 \uD544\uC694\uD569\uB2C8\uB2E4. \uC608: /lobby?userId=1");return}let s=new w("/socket",{params:{user_id:t}});s.connect();let n=s.channel(`user_lobby:${t}`,{}),a=document.getElementById("user-room-list"),o=document.getElementById("chat-lobby"),r=document.getElementById("chat-room"),i=document.getElementById("room-title"),c=document.getElementById("messages"),d=document.getElementById("message-input"),v=document.getElementById("send-button"),m=document.getElementById("back-button"),u=null;n.join().receive("ok",()=>console.log("\u2705 \uC720\uC800 \uB85C\uBE44 \uC811\uC18D \uC131\uACF5")).receive("error",()=>console.error("\u274C \uB85C\uBE44 \uCC44\uB110 \uC811\uC18D \uC2E4\uD328")),n.on("room_list",p=>{a.innerHTML="",p.rooms.forEach(h=>{let l=document.createElement("div");l.className="chat-room-item",l.innerHTML=`
        <div class="room-info">
          <span class="room-name">${h.name}</span>
          <span class="room-unread">${h.unread_count||0}</span>
        </div>
      `,l.addEventListener("click",()=>C(h.id,h.name)),a.appendChild(l)})});function C(p,h){o.style.display="none",r.style.display="block",i.innerText=h;let l=[];u&&u.leave(),u=s.channel(`talk:${p}`,{user_id:t}),u.join().receive("ok",()=>{console.log(`\u2705 \uCC44\uD305\uBC29 ${p} \uC785\uC7A5 \uC131\uACF5`),u.push("fetch_messages",{})}).receive("error",()=>console.error("\u274C \uCC44\uD305\uBC29 \uC785\uC7A5 \uC2E4\uD328")),u.on("messages",g=>{let y=g.messages;l=y,c.innerHTML="",y.forEach(b=>{f(b,b.sender_id===t)})}),u.on("new_msg",g=>{f(g,g.sender_id===t)}),u.on("messages:prepend",g=>{let y=c.scrollHeight;g.messages.forEach(b=>{if(l.some(_=>_.message_id===b.message_id))return;l.unshift(b);let T=document.createElement("div");T.className=b.sender_id===t?"message mine":"message other",T.innerHTML=`<div class="bubble">${b.content}</div>`,c.prepend(T)}),c.scrollTop=c.scrollHeight-y}),c.addEventListener("scroll",()=>{if(c.scrollTop===0&&l.length>0){let g=l[0].message_id;u.push("load_more",{last_seen_key:g})}})}function f(p,h){let l=document.createElement("div");l.className=h?"message mine":"message other",l.innerHTML=`
          <div class="message-content">
            <div class="bubble">${p.content}</div>
            <div class="message-time">${R(p.sent_at)}</div>
          </div>
        `,c.appendChild(l),c.scrollTop=c.scrollHeight}function R(p){return new Date(p).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit",hour12:!1})}let L=!1;d.addEventListener("compositionstart",()=>{L=!0}),d.addEventListener("compositionend",()=>{L=!1}),v.addEventListener("click",B),d.addEventListener("keydown",function(p){L||p.key==="Enter"&&(p.preventDefault(),B())});function B(){let p=d.value.trim();!p||!u||(u.push("new_msg",{user:t,message:p}),d.value="")}m.addEventListener("click",()=>{u&&u.leave(),r.style.display="none",o.style.display="block",n.push(`user_lobby:${t}`,{})})});})();
